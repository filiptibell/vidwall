source:
  id: "la_mega"
  name: "La Mega"
  country: "CO"
  language: "es"
  headless: true
  proxy: "socks5://127.0.0.1:1080"

# Discovery phase: La Mega has a single TikTok live channel
# The stream data is embedded in the SIGI_STATE JSON in the HTML
# Uses Fetch instead of browser to avoid TikTok's automation detection

discovery:
  outputs:
    id: "${{fetch_page.id}}"
    name: "${{fetch_page.name}}"
    image: "${{fetch_page.image}}"
    expires_in: 86400 # Refresh discovery daily

  steps:
    - name: "fetch_page"
      kind: Fetch
      url: "https://www.tiktok.com/@lamegacolombia/live"
      extract:
        id:
          kind: regex
          path: '"roomId":"(\d+)"'
        name:
          kind: regex
          path: '"nickname":"([^"]+)"'
        image:
          kind: regex
          path: '"avatarLarger":"([^"]+)"'
          unescape: true

# Content phase: extract the 1080p60 (UHD60) stream URL from the page
# TikTok embeds stream URLs in SIGI_STATE JSON with \\u0026 for &

content:
  outputs:
    manifest_url: "${{fetch_page.stream_url}}"
    expires_at: "${{fetch_page.expires_at}}"

  steps:
    - name: "fetch_page"
      kind: Fetch
      url: "https://www.tiktok.com/@lamegacolombia/live"
      extract:
        # Match the UHD60 HLS stream URL (1080p60)
        # URL format: https://pull-hls-XXX.tiktokcdn.com/game/stream-XXXXX_uhd60/playlist.m3u8?expire=XXX\\u0026sign=XXX
        stream_url:
          kind: regex
          path: '(https://pull-hls[^"]+_uhd60/playlist\.m3u8\?expire=\d+\\\\u0026sign=[a-f0-9]+)'
          unescape: true
        expires_at:
          kind: regex
          path: 'https://pull-hls[^"]+_uhd60/playlist\.m3u8\?expire=(\d+)'
